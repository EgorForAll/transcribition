services:
  postgres:
    image: postgres:15-alpine
    container_name: transcription-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-transcription_db}
      POSTGRES_USER: ${POSTGRES_USER:-transcription_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-transcription_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - transcription-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: transcription-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - transcription-network
    restart: unless-stopped

  transcription-api:
    build: .
    container_name: transcription-api
    ports:
      - "${PORT:-8000}:8000"
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
      - ./logs:/app/logs
      - ./app:/app/app  # –î–ª—è hot-reload –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
    environment:
      # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      - APP_NAME=${APP_NAME:-Audio Transcription Service}
      - VERSION=${VERSION:-1.0.0}
      - DEBUG=${DEBUG:-true}

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
      - HOST=0.0.0.0
      - PORT=8000

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Whisper
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-cpu}

      # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
      - DATABASE_URL=postgresql://${POSTGRES_USER:-transcription_user}:${POSTGRES_PASSWORD:-transcription_password}@postgres:5432/${POSTGRES_DB:-transcription_db}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-transcription_db}
      - POSTGRES_USER=${POSTGRES_USER:-transcription_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-transcription_password}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis_password}
      - REDIS_ENABLED=true

      # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
      - ANALYTICS_ENABLED=${ANALYTICS_ENABLED:-true}

      # API Keys
      - API_KEYS=${API_KEYS:-test_key}

      # –í–Ω–µ—à–Ω–∏–π API
      - EXTERNAL_API_ENABLED=${EXTERNAL_API_ENABLED:-false}
      - EXTERNAL_API_URL=${EXTERNAL_API_URL:-}
      - EXTERNAL_API_TIMEOUT=${EXTERNAL_API_TIMEOUT:-30}
    depends_on:
      - postgres
      - redis
    networks:
      - transcription-network
    restart: unless-stopped
    command: >
      bash -c "
        echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ PostgreSQL...'
        while ! nc -z postgres 5432; do sleep 1; done
        echo '‚úÖ PostgreSQL –≥–æ—Ç–æ–≤'
        echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Redis...'
        while ! nc -z redis 6379; do sleep 1; done
        echo '‚úÖ Redis –≥–æ—Ç–æ–≤'
        echo 'üß† –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...'
        python -c 'from app.database import engine; from app.analytics.models import Base; Base.metadata.create_all(bind=engine)'
        echo '‚úÖ –¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã'
        echo 'üöÄ –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–∏—Å–∞...'
        uvicorn app.main:app --host 0.0.0.0 --port 8000
      "

  streamlit-demo:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: transcription-streamlit
    ports:
      - "${DEMO_PORT:-8501}:8501"
    volumes:
      - ./streamlit-app:/app
    environment:
      - API_URL=http://transcription-api:8000
      - API_BASE_URL=http://transcription-api:8000
    depends_on:
      - transcription-api
    networks:
      - transcription-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  transcription-network:
    driver: bridge